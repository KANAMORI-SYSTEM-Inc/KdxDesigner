<Window x:Class="KdxDesigner.Views.ControlBoxViews"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="ControlBoxViews" Height="640" Width="1080"
        WindowStartupLocation="CenterOwner">

    <Grid Margin="8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="520" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock Grid.ColumnSpan="2" Grid.Row="0" Margin="0,0,0,8"
             Text="Cylinder ↔ ControlBox Mapping (Multiple)"
             FontSize="16" FontWeight="Bold" />

        <!-- 左：Cylinder 一覧（既出と同様） -->
        <DataGrid Grid.Row="1" Grid.Column="0"
            ItemsSource="{Binding Cylinders}"
            SelectedItem="{Binding SelectedCylinder, Mode=TwoWay}"
            AutoGenerateColumns="False" IsReadOnly="True"
            CanUserAddRows="False" CanUserDeleteRows="False"
            CanUserSortColumns="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Sort" Binding="{Binding Cylinder.SortNumber}" Width="60"/>
                <DataGridTextColumn Header="CY#"  Binding="{Binding Cylinder.CYNum}" Width="90"/>
                <DataGridTextColumn Header="Machine" Binding="{Binding DisplayMachineName}" Width="160"/>
                <DataGridTextColumn Header="Go" Binding="{Binding Cylinder.Go}" Width="120"/>
                <DataGridTextColumn Header="Back" Binding="{Binding Cylinder.Back}" Width="120"/>
                <DataGridTextColumn Header="Cycle"
    Binding="{Binding CylinderCycle.CycleId}"
    Width="60"/>

            </DataGrid.Columns>
        </DataGrid>

        <!-- 右：複数割付の編集 -->
        <DockPanel Grid.Row="1" Grid.Column="1" LastChildFill="True">
            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,6" >
                <TextBlock Text="選択中:" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding SelectedCylinder.Cylinder.CYNum, FallbackValue=—}"
                 FontWeight="Bold" Margin="4,0"/>
                <Button Content="行を追加" Command="{Binding AddMappingCommand}" Margin="4,0,0,0"/>
                <Button Content="すべて保存" Command="{Binding SaveAllMappingsCommand}" Margin="4,0,0,0"/>
                <Button Content="すべて削除" Command="{Binding DeleteAllMappingsCommand}" Margin="4,0,0,0"
                        Background="#FFF0E0E0" Foreground="Red"/>
            </StackPanel>

            <DataGrid ItemsSource="{Binding Mappings}"
              AutoGenerateColumns="False"
              CanUserAddRows="False" CanUserDeleteRows="False"
              HeadersVisibility="Column"
              GridLinesVisibility="Horizontal">
                <DataGrid.Columns>
                    <!-- ControlBox 選択（BoxNumber を選ぶ） -->
                    <DataGridTemplateColumn Header="ControlBox">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding DataContext.ControlBoxes, RelativeSource={RelativeSource AncestorType=Window}}"
                                          SelectedValuePath="BoxNumber"
                                          DisplayMemberPath="BoxNumber"
                                          SelectedValue="{Binding BoxNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          MinWidth="220"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- ManualNumber（通常は BoxNumber と同じ。手で上書きも可能） -->
                    <DataGridTextColumn Header="ManualNumber"
                                        Binding="{Binding ManualNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Width="120"/>

                    <!-- Device -->
                    <DataGridTextColumn Header="Device"
                                        Binding="{Binding Device, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Width="200"/>

                    <!-- 削除ボタン -->
                    <DataGridTemplateColumn Width="70">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="削除"
                                        Command="{Binding DataContext.RemoveMappingCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>
    </Grid>

</Window>
