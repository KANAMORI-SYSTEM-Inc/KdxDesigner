<Window x:Class="KdxDesigner.Views.TimerEditorView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="タイマー設定" Height="600" Width="1000"
        WindowStartupLocation="CenterOwner">
    
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:NullCategoryConverter x:Key="NullCategoryConverter" xmlns:local="clr-namespace:KdxDesigner.Utils"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- ローディング表示 -->
        <Grid Grid.RowSpan="3" Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
              Background="#80000000" Panel.ZIndex="1000">
            <Border Background="White" CornerRadius="10" Width="200" Height="100"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="150" Height="20" Margin="10"/>
                    <TextBlock Text="読み込み中..." HorizontalAlignment="Center" Margin="10"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- ツールバー -->
        <ToolBar Grid.Row="0">
            <Button Content="タイマー追加" Command="{Binding AddTimerCommand}" Margin="5,0"/>
            <Button Content="タイマー削除" Command="{Binding DeleteTimerCommand}" 
                    IsEnabled="{Binding IsTimerSelected}" Margin="5,0"/>
            <Separator/>
            <Button Content="一括保存" Command="{Binding SaveAllTimersCommand}" 
                    IsEnabled="{Binding HasChanges}" Margin="5,0" Background="LightYellow"
                    ToolTip="DataGridで編集した内容をまとめて保存します"/>
            <Button Content="更新" Command="{Binding RefreshCommand}" Margin="5,0"
                    ToolTip="タイマー一覧を再読み込みします"/>
            <Separator/>
            <Button Content="MnemonicTimerDevice生成" Command="{Binding GenerateMnemonicTimerDevicesCommand}" 
                    Margin="5,0" Background="LightGreen"/>
            <Button Content="MnemonicTimerDevice表示" Command="{Binding ViewMnemonicTimerDevicesCommand}" 
                    Margin="5,0"/>
        </ToolBar>

        <!-- メインコンテンツ -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="400"/>
            </Grid.ColumnDefinitions>

            <!-- 左側：タイマー一覧 -->
            <GroupBox Grid.Column="0" Header="タイマー一覧" Margin="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- フィルタ -->
                    <Grid Grid.Row="0" Margin="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="MnemonicType:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <ComboBox Grid.Column="1" ItemsSource="{Binding MnemonicTypes}" 
                                  SelectedItem="{Binding SelectedMnemonicType}"
                                  DisplayMemberPath="TableName"/>
                        <CheckBox Grid.Column="2" Content="未設定のみ表示" 
                                  IsChecked="{Binding ShowUnassignedOnly}" 
                                  VerticalAlignment="Center" Margin="10,0,0,0"/>
                    </Grid>

                    <TextBox Grid.Row="1" Margin="5" 
                             Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="Tag" Value="検索..."/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>

                    <!-- タイマーリスト -->
                    <DataGrid Grid.Row="2" ItemsSource="{Binding FilteredTimers}" 
                              SelectedItem="{Binding SelectedTimer}"
                              AutoGenerateColumns="False" CanUserAddRows="False" Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding ID, Mode=OneWay}" Width="50" IsReadOnly="True"/>
                            <DataGridTextColumn Header="タイマー名" Binding="{Binding TimerName, UpdateSourceTrigger=PropertyChanged}" Width="150"/>
                            <DataGridComboBoxColumn Header="サイクル" Width="100"
                                                    SelectedValueBinding="{Binding CycleId}"
                                                    SelectedValuePath="Id"
                                                    DisplayMemberPath="CycleName">
                                <DataGridComboBoxColumn.ElementStyle>
                                    <Style TargetType="ComboBox">
                                        <Setter Property="ItemsSource" Value="{Binding DataContext.Cycles, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </Style>
                                </DataGridComboBoxColumn.ElementStyle>
                                <DataGridComboBoxColumn.EditingElementStyle>
                                    <Style TargetType="ComboBox">
                                        <Setter Property="ItemsSource" Value="{Binding DataContext.Cycles, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </Style>
                                </DataGridComboBoxColumn.EditingElementStyle>
                            </DataGridComboBoxColumn>
                            <DataGridTemplateColumn Header="カテゴリ" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding CategoryName}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.TimerCategoriesWithNull, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  SelectedValue="{Binding TimerCategoryId, UpdateSourceTrigger=PropertyChanged}"
                                                  SelectedValuePath="Id">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource NullCategoryConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="タイマー番号" Binding="{Binding TimerNum, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                            <DataGridComboBoxColumn Header="MnemonicType" Width="120"
                                                    SelectedValueBinding="{Binding MnemonicId}"
                                                    SelectedValuePath="Id"
                                                    DisplayMemberPath="TableName">
                                <DataGridComboBoxColumn.ElementStyle>
                                    <Style TargetType="ComboBox">
                                        <Setter Property="ItemsSource" Value="{Binding DataContext.MnemonicTypes, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </Style>
                                </DataGridComboBoxColumn.ElementStyle>
                                <DataGridComboBoxColumn.EditingElementStyle>
                                    <Style TargetType="ComboBox">
                                        <Setter Property="ItemsSource" Value="{Binding DataContext.MnemonicTypes, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </Style>
                                </DataGridComboBoxColumn.EditingElementStyle>
                            </DataGridComboBoxColumn>
                            <DataGridTextColumn Header="RecordIds" Binding="{Binding RecordIdsDisplay, Mode=OneWay}" Width="200" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Example" Binding="{Binding Example, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- 右側：詳細編集 -->
            <GroupBox Grid.Column="1" Header="タイマー詳細" Margin="5">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="10" IsEnabled="{Binding IsTimerSelected}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- ID -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="ID:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTimer.ID, Mode=OneWay}" IsReadOnly="True" 
                                 Background="LightGray" Margin="0,5"/>

                        <!-- タイマー名 -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="タイマー名:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTimer.TimerName, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="0,5"/>

                        <!-- サイクル -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="サイクル:" VerticalAlignment="Center" Margin="0,5"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" ItemsSource="{Binding Cycles}" 
                                  SelectedValue="{Binding SelectedTimer.CycleId}"
                                  SelectedValuePath="Id" DisplayMemberPath="CycleName" Margin="0,5"/>

                        <!-- タイマーカテゴリ -->
                        <TextBlock Grid.Row="3" Grid.Column="0" Text="カテゴリ:" VerticalAlignment="Center" Margin="0,5"/>
                        <ComboBox Grid.Row="3" Grid.Column="1" ItemsSource="{Binding TimerCategoriesWithNull}" 
                                  SelectedValue="{Binding SelectedTimer.TimerCategoryId}"
                                  SelectedValuePath="Id" Margin="0,5">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource NullCategoryConverter}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <!-- タイマー番号 -->
                        <TextBlock Grid.Row="4" Grid.Column="0" Text="タイマー番号:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTimer.TimerNum, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="0,5"/>

                        <!-- MnemonicType -->
                        <TextBlock Grid.Row="5" Grid.Column="0" Text="MnemonicType:" VerticalAlignment="Center" Margin="0,5"/>
                        <ComboBox Grid.Row="5" Grid.Column="1" ItemsSource="{Binding MnemonicTypes}" 
                                  SelectedValue="{Binding SelectedTimer.MnemonicId}"
                                  SelectedValuePath="Id" DisplayMemberPath="TableName" Margin="0,5"/>

                        <!-- RecordIds -->
                        <TextBlock Grid.Row="6" Grid.Column="0" Text="RecordIds:" VerticalAlignment="Top" Margin="0,5"/>
                        <Grid Grid.Row="6" Grid.Column="1" Margin="0,5">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- 編集ボタン -->
                            <Button Grid.Row="0" Content="RecordIds編集..." 
                                    Command="{Binding EditRecordIdsCommand}" 
                                    HorizontalAlignment="Left" Width="120" Height="25"/>
                            
                            <!-- 選択されたRecordIds表示 -->
                            <Border Grid.Row="1" BorderBrush="LightGray" BorderThickness="1" 
                                    CornerRadius="3" Margin="0,5,0,0" Padding="5" 
                                    Background="LightYellow">
                                <ScrollViewer MaxHeight="80" VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding SelectedTimer.RecordIds}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border BorderBrush="DarkGray" BorderThickness="1" 
                                                        CornerRadius="3" Margin="2" Padding="3,1">
                                                    <TextBlock Text="{Binding}" FontFamily="Consolas"/>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </Grid>

                        <!-- Example -->
                        <TextBlock Grid.Row="7" Grid.Column="0" Text="Example:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="7" Grid.Column="1" Text="{Binding SelectedTimer.Example, UpdateSourceTrigger=PropertyChanged}" 
                                 Margin="0,5"/>

                        <!-- 保存ボタン -->
                        <Button Grid.Row="8" Grid.Column="1" Content="保存" 
                                Command="{Binding SaveSelectedTimerCommand}"
                                IsEnabled="{Binding CanSaveSelectedTimer}"
                                HorizontalAlignment="Left" Width="100" Margin="0,10"/>
                    </Grid>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- 下部ボタン -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="閉じる" Width="100" Click="CloseButton_Click"/>
        </StackPanel>
    </Grid>
</Window>