<Window x:Class="KdxDesigner.Views.InterlockSettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="インターロック設定" Height="700" Width="1200">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="200"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="LightGray" Padding="10">
            <StackPanel>
                <TextBlock FontSize="16" FontWeight="Bold" Text="インターロック設定"/>
                <TextBlock FontSize="14" Margin="0,5,0,0">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="選択中のシリンダー: {0} - {1}">
                            <Binding Path="SelectedCylinder.CYNum"/>
                            <Binding Path="SelectedCylinder.PUCO"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
                <TextBlock FontSize="14" Margin="0,5,0,0" Text="{Binding SelectedInterlock.CylinderNum, StringFormat='選択中のインターロック: {0}'}"/>
            </StackPanel>
        </Border>

        <!-- Cylinder Selection -->
        <GroupBox Grid.Row="1" Header="シリンダー選択" Margin="10,5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Search Box -->
                <Grid Grid.Row="0" Margin="5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="検索:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <TextBox Grid.Column="1" Name="CylinderSearchTextBox"
                             Text="{Binding CylinderSearchText, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,10,0"/>
                    <Button Grid.Column="2" Content="クリア" Width="60" Margin="0,0,10,0"
                            Command="{Binding ClearCylinderSearchCommand}"/>
                </Grid>

                <!-- Cylinder List -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding FilteredCylinders}"
                          SelectedItem="{Binding SelectedCylinder}"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          CanUserAddRows="False"
                          Margin="5">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="50"/>
                        <DataGridTextColumn Header="CYNum" Binding="{Binding CYNum}" Width="100"/>
                        <DataGridTextColumn Header="機械名" Binding="{Binding MachineNameFullName}" Width="150"/>
                        <DataGridTextColumn Header="PUCO" Binding="{Binding PUCO}" Width="100"/>
                        <DataGridTextColumn Header="Go" Binding="{Binding Go}" Width="100"/>
                        <DataGridTextColumn Header="Back" Binding="{Binding Back}" Width="100"/>
                        <DataGridTextColumn Header="OilNum" Binding="{Binding OilNum}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>

        <!-- Main Content -->
        <Grid Grid.Row="2" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <!-- Interlock List -->
            <GroupBox Grid.Column="0" Header="インターロック" Margin="0,0,5,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Interlock Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddInterlockCommand}" Content="追加"/>
                        <Button Command="{Binding DeleteInterlockCommand}" Content="削除"/>
                        <Separator/>
                        <Button Command="{Binding EditPreConditionsCommand}" Content="前提条件編集"/>
                    </ToolBar>

                    <!-- Interlock DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Interlocks}"
                              SelectedItem="{Binding SelectedInterlock}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ソート" Binding="{Binding SortId}" Width="50"/>
                            <DataGridTextColumn Header="条件CY ID" Binding="{Binding ConditionCylinderId}" Width="70"/>
                            <DataGridTextColumn Header="CY番号" Binding="{Binding ConditionCylinderNum}" Width="80" IsReadOnly="True"/>
                            <DataGridTextColumn Header="前提条件1" Binding="{Binding PreConditionID1}" Width="70" IsReadOnly="False"/>
                            <DataGridTextColumn Header="前提条件2" Binding="{Binding PreConditionID2}" Width="*" IsReadOnly="False"/>
                            <DataGridTextColumn Header="行きor帰り" Binding="{Binding GoOrBack}" Width="*" IsReadOnly="False"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- Interlock Conditions -->
            <GroupBox Grid.Column="1" Header="インターロック条件" Margin="5,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Condition Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddConditionCommand}" Content="追加" IsEnabled="{Binding IsInterlockSelected}"/>
                        <Button Command="{Binding DeleteConditionCommand}" Content="削除"/>
                    </ToolBar>

                    <!-- Conditions DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding InterlockConditions}"
                              SelectedItem="{Binding SelectedCondition}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="条件番号" Binding="{Binding ConditionNumber}" Width="70"/>
                            <DataGridTemplateColumn Header="条件タイプ" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding ConditionType.ConditionTypeName}"
                                                   ToolTip="{Binding ConditionType.Discription}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding DataContext.ConditionTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  SelectedValuePath="Id"
                                                  SelectedValue="{Binding ConditionTypeId, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ConditionTypeName}"
                                                               ToolTip="{Binding Discription}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="説明" Binding="{Binding ConditionType.Discription}" Width="*" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>

            <!-- Interlock IO -->
            <GroupBox Grid.Column="2" Header="インターロックIO" Margin="5,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- IO Toolbar -->
                    <ToolBar Grid.Row="0">
                        <Button Command="{Binding AddIOCommand}" Content="IO選択" IsEnabled="{Binding IsConditionSelected}"/>
                        <Button Command="{Binding DeleteIOCommand}" Content="削除"/>
                    </ToolBar>

                    <!-- IO DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding InterlockIOs}"
                              SelectedItem="{Binding SelectedIO}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="0,5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="PLC ID" Binding="{Binding PlcId}" Width="60" IsReadOnly="True"/>
                            <DataGridTextColumn Header="IOアドレス" Binding="{Binding IOAddress}" Width="100" IsReadOnly="True"/>
                            <DataGridTextColumn Header="IO名称" Binding="{Binding IOName}" Width="*" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="ON条件" Binding="{Binding IsOnCondition}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </GroupBox>
        </Grid>

        <!-- Bottom Buttons -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="保存" Width="100" Height="30" Margin="5" Command="{Binding SaveCommand}"/>
            <Button Content="キャンセル" Width="100" Height="30" Margin="5" Command="{Binding CancelCommand}"/>
        </StackPanel>
    </Grid>
</Window>